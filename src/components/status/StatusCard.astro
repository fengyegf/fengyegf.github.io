---
import path from "path";
import { getDir } from "@utils/url-utils";
import { formatDateToYYYYMMDD } from "@utils/date-utils";
import type { ImageMetadata } from "astro";
import type { CollectionEntry } from "astro:content";

interface Props {
  entry: CollectionEntry<"status">;
  class?: string;
  style?: string;
}

const { entry, class: className, style } = Astro.props;
const { content, published, images = [], video, videoCover } = entry.data;

// 计算发布日期距今天数
const now = new Date();
const publishDate = new Date(published);
const diffTime = Math.abs(now.getTime() - publishDate.getTime());
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

// 图片基础路径
const dir = getDir(entry.id);
const cleanDir = dir === "/" ? "" : dir;
const basePath = path.join("content/status", cleanDir);

// 判断是否为远程URL
const isRemoteUrl = (url: string) =>
  url.startsWith("http://") || url.startsWith("https://");

// 获取图片相关信息
const getImageInfo = (image: string | ImageMetadata) => {
  if (typeof image === "string") {
    // 处理相对路径，类似于 getImageUrl 逻辑
    if (!isRemoteUrl(image)) {
      const url = `/${basePath}/${image}`;
      return {
        src: url.replace(/\\/g, "/").replace(/\/+/g, "/"),
        width: 1200,
        height: 1200,
      };
    }
    return {
      src: image,
      width: 1200, // 默认宽
      height: 1200, // 默认高
    };
  }
  return {
    src: image.src,
    width: image.width,
    height: image.height,
  };
};

// 获取本地视频文件映射
// 使用 import.meta.glob 获取所有视频文件的 URL
const videoFiles = import.meta.glob(
  "/src/content/status/**/*.{mp4,webm,ogg,mov}",
  { query: "?url", import: "default" },
);

// 解析视频 URL
let resolvedVideoUrl = video;
if (video && !isRemoteUrl(video)) {
  const videoPath = path.join(cleanDir, video).replace(/\\/g, "/");
  const fullPath = `/src/content/status/${videoPath}`;

  if (fullPath in videoFiles) {
    resolvedVideoUrl = (await videoFiles[fullPath]()) as string;
  }
}
---

<div
  class:list={[
    "status-card group card-base rounded-[var(--radius-large)] overflow-hidden p-5 md:p-8",
    "transition-all duration-300 hover:-translate-y-1 hover:shadow-xl",
    className,
  ]}
  style={style}
>
  <!-- 内容文字 -->
  <div
    class="text-sm md:text-lg text-black/80 dark:text-white/80 mb-5 md:mb-6 leading-relaxed whitespace-pre-wrap"
  >
    {content}
  </div>

  <!-- 视频播放器 -->
  {
    video && (
      <div class="video-container mb-6 rounded-lg overflow-hidden bg-black/5 dark:bg-white/5">
        <video
          controls
          playsinline
          preload="metadata"
          poster={videoCover}
          class="w-full max-h-[500px] object-contain"
        >
          <source src={resolvedVideoUrl} type="video/mp4" />
          您的浏览器不支持视频播放。
        </video>
      </div>
    )
  }

  <!-- 图片网格 -->
  {
    images.length > 0 && (
      <div
        class:list={[
          "image-grid gap-2 md:gap-3 mb-6",
          {
            "grid grid-cols-1": images.length === 1,
            "grid grid-cols-2": images.length === 2 || images.length === 4,
            "grid grid-cols-2 md:grid-cols-3":
              images.length === 3 || images.length > 4,
          },
        ]}
      >
        {images.map((image: string | ImageMetadata, index: number) => {
          const imgInfo = getImageInfo(image);
          const isSingleImage = images.length === 1;
          return (
            <a
              href={imgInfo.src}
              class:list={[
                "block relative overflow-hidden rounded-lg",
                "transition-transform duration-300 active:scale-95 md:hover:scale-105",
                "cursor-pointer touch-manipulation",
                {
                  "aspect-square": !isSingleImage,
                  "col-span-2": images.length === 3 && index === 0,
                },
              ]}
              data-pswp-width={imgInfo.width}
              data-pswp-height={imgInfo.height}
            >
              <img
                src={imgInfo.src}
                alt={`Image ${index + 1}`}
                class:list={[
                  "w-full select-none",
                  {
                    "h-full object-cover": !isSingleImage,
                    "object-contain max-h-[500px] bg-black/5 dark:bg-white/5":
                      isSingleImage,
                  },
                ]}
                loading="lazy"
                draggable="false"
                onerror="const l=this.closest('a'); const g=l.parentElement; l.remove(); if(g.children.length===0) { g.style.display='none'; g.classList.remove('mb-6'); }"
              />
            </a>
          );
        })}
      </div>
    )
  }

  <!-- 时间信息 -->
  <div
    class="flex items-center text-xs md:text-sm text-black/40 dark:text-white/40"
  >
    <svg
      class="w-3.5 h-3.5 md:w-4 md:h-4 mr-1.5 md:mr-2"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <span>{diffDays}天前</span>
    <span class="mx-1.5 md:mx-2">·</span>
    <span class="hidden sm:inline">{formatDateToYYYYMMDD(published)}</span>
    <span class="sm:hidden">{formatDateToYYYYMMDD(published).slice(5)}</span>
  </div>
</div>

<style>
  .status-card {
    background: var(--card-bg);
  }

  .status-card:hover {
    box-shadow:
      0 10px 15px -3px rgba(0, 0, 0, 0.08),
      0 4px 6px -4px rgba(0, 0, 0, 0.05);
  }

  :global(.dark) .status-card:hover {
    box-shadow:
      0 10px 15px -3px rgba(0, 0, 0, 0.4),
      0 4px 6px -4px rgba(0, 0, 0, 0.3);
  }

  .image-grid a {
    cursor: zoom-in;
  }

  /* 单张图片特殊处理 */
  .image-grid.grid-cols-1 a {
    max-height: 500px;
  }
</style>
