---
import path from "path";
import { getDir } from "@utils/url-utils";
import { formatDateToYYYYMMDD } from "@utils/date-utils";

interface Props {
  entry: any;
  class?: string;
  style?: string;
}

const { entry, class: className, style } = Astro.props;
const { content, published, images = [] } = entry.data;

// 计算发布日期距今天数
const now = new Date();
const publishDate = new Date(published);
const diffTime = Math.abs(now.getTime() - publishDate.getTime());
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

// 图片基础路径
const basePath = path.join("content/status/", getDir(entry.id));

// 判断是否为远程URL
const isRemoteUrl = (url: string) =>
  url.startsWith("http://") || url.startsWith("https://");

// 获取图片完整路径
const getImageUrl = (image: string) => {
  return isRemoteUrl(image) ? image : `/${basePath}/${image}`;
};
---

<div
  class:list={[
    "status-card group card-base rounded-[var(--radius-large)] overflow-hidden p-5 md:p-8",
    "transition-all duration-300 hover:-translate-y-1 hover:shadow-xl",
    className,
  ]}
  style={style}
>
  <!-- 内容文字 -->
  <div
    class="text-sm md:text-lg text-black/80 dark:text-white/80 mb-5 md:mb-6 leading-relaxed whitespace-pre-wrap"
  >
    {content}
  </div>

  <!-- 图片网格 -->
  {
    images.length > 0 && (
      <div
        class:list={[
          "image-grid gap-2 md:gap-3 mb-6",
          {
            "grid grid-cols-1": images.length === 1,
            "grid grid-cols-2": images.length === 2 || images.length === 4,
            "grid grid-cols-2 md:grid-cols-3":
              images.length === 3 || images.length > 4,
          },
        ]}
      >
        {images.map((image: string, index: number) => {
          const imageUrl = getImageUrl(image);
          const isSingleImage = images.length === 1;
          return (
            <a
              href={imageUrl}
              class:list={[
                "block relative overflow-hidden rounded-lg",
                "transition-transform duration-300 active:scale-95 md:hover:scale-105",
                "cursor-pointer touch-manipulation",
                {
                  "aspect-square": !isSingleImage,
                  "col-span-2": images.length === 3 && index === 0,
                },
              ]}
              data-pswp-width="1200"
              data-pswp-height="1200"
            >
              <img
                src={imageUrl}
                alt={`Image ${index + 1}`}
                class:list={[
                  "w-full select-none",
                  {
                    "h-full object-cover": !isSingleImage,
                    "object-contain": isSingleImage,
                  },
                ]}
                loading="lazy"
                draggable="false"
              />
            </a>
          );
        })}
      </div>
    )
  }

  <!-- 时间信息 -->
  <div
    class="flex items-center text-xs md:text-sm text-black/40 dark:text-white/40"
  >
    <svg
      class="w-3.5 h-3.5 md:w-4 md:h-4 mr-1.5 md:mr-2"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <span>{diffDays}天前</span>
    <span class="mx-1.5 md:mx-2">·</span>
    <span class="hidden sm:inline">{formatDateToYYYYMMDD(published)}</span>
    <span class="sm:hidden">{formatDateToYYYYMMDD(published).slice(5)}</span>
  </div>
</div>

<style>
  .status-card {
    background: var(--card-bg);
  }

  .status-card:hover {
    box-shadow:
      0 10px 15px -3px rgba(0, 0, 0, 0.08),
      0 4px 6px -4px rgba(0, 0, 0, 0.05);
  }

  :global(.dark) .status-card:hover {
    box-shadow:
      0 10px 15px -3px rgba(0, 0, 0, 0.4),
      0 4px 6px -4px rgba(0, 0, 0, 0.3);
  }

  .image-grid a {
    cursor: zoom-in;
  }

  /* 单张图片特殊处理 */
  .image-grid.grid-cols-1 a {
    max-height: 500px;
  }
</style>
