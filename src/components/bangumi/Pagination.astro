---
import { Icon } from "astro-icon/components";

interface Props {
  totalItems: number;
  itemsPerPage: number;
  currentPage: number;
  sectionId: string;
}

const { totalItems, itemsPerPage, currentPage, sectionId } = Astro.props;
const totalPages = Math.ceil(totalItems / itemsPerPage);

// 生成智能分页页码数组
function generatePageNumbers(current: number, total: number) {
  const delta = 2; // 当前页左右显示的页码数量
  const range = [];
  const rangeWithDots = [];

  // 如果总页数小于等于7，显示所有页码
  if (total <= 7) {
    for (let i = 1; i <= total; i++) {
      range.push(i);
    }
    return range;
  }

  // 计算显示范围
  const left = Math.max(2, current - delta);
  const right = Math.min(total - 1, current + delta);

  // 始终显示第一页
  rangeWithDots.push(1);

  // 如果左边界大于2，添加省略号
  if (left > 2) {
    rangeWithDots.push("...");
  }

  // 添加中间页码
  for (let i = left; i <= right; i++) {
    rangeWithDots.push(i);
  }

  // 如果右边界小于最后一页-1，添加省略号
  if (right < total - 1) {
    rangeWithDots.push("...");
  }

  // 始终显示最后一页（如果总页数大于1）
  if (total > 1) {
    rangeWithDots.push(total);
  }

  return rangeWithDots;
}

const pageNumbers = generatePageNumbers(currentPage, totalPages);
---

{totalPages > 1 && (
  <div class="flex flex-row gap-3 justify-center mt-8" data-pagination-section={sectionId}>
    <!-- Prev Button -->
    <button
      type="button"
      class="btn-card overflow-hidden rounded-lg text-[var(--primary)] w-11 h-11 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
      data-page="prev"
      data-section={sectionId}
      disabled={currentPage === 1}
      aria-label="Previous Page"
    >
      <Icon name="material-symbols:chevron-left-rounded" class="text-[1.75rem]" />
    </button>

    <!-- Page Numbers -->
    <div class="bg-[var(--card-bg)] flex flex-row rounded-lg items-center text-neutral-700 dark:text-neutral-300 font-bold" data-page-numbers={sectionId}>
      {pageNumbers.map((pageItem) => (
        pageItem === '...' ? (
           <Icon name="material-symbols:more-horiz" class="mx-1 text-neutral-500" />
        ) : (
            pageItem === currentPage ? (
                <div class="h-11 w-11 rounded-lg bg-[var(--primary)] flex items-center justify-center font-bold text-white dark:text-black/70">
                    {pageItem}
                </div>
            ) : (
                <button
                    type="button"
                    class="btn-card w-11 h-11 rounded-lg overflow-hidden active:scale-[0.85]"
                    data-page={pageItem}
                    data-section={sectionId}
                    aria-label={`Page ${pageItem}`}
                >
                    {pageItem}
                </button>
            )
        )
      ))}
    </div>

    <!-- Next Button -->
    <button
      type="button"
      class="btn-card overflow-hidden rounded-lg text-[var(--primary)] w-11 h-11 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
      data-page="next"
      data-section={sectionId}
      disabled={currentPage === totalPages}
      aria-label="Next Page"
    >
      <Icon name="material-symbols:chevron-right-rounded" class="text-[1.75rem]" />
    </button>
  </div>
)}

<script define:vars={{ itemsPerPage, sectionId }}>
  function initPagination() {
    let currentPage = 1;

    const pagination = document.querySelector(`[data-pagination-section="${sectionId}"]`);
    if (!pagination) return;

    const prevBtn = pagination.querySelector('[data-page="prev"]');
    const nextBtn = pagination.querySelector('[data-page="next"]');

    if (prevBtn) {
        prevBtn.addEventListener('click', function() {
            currentPage = Math.max(1, currentPage - 1);
            updatePage();
        });
    }

    if (nextBtn) {
        nextBtn.addEventListener('click', function() {
            const items = document.querySelectorAll(`[data-item-section="${sectionId}"]:not(.hidden)`);
            const totalPages = Math.ceil(items.length / itemsPerPage);
            currentPage = Math.min(totalPages, currentPage + 1);
            updatePage();
        });
    }

    // Listen for filter updates
    if (pagination) {
      pagination.addEventListener('updatePagination', function(event) {
        currentPage = 1;
        updatePage();
      });
    }

    function updatePage() {
      const items = document.querySelectorAll(`[data-item-section="${sectionId}"]:not(.hidden)`);
      const totalPages = Math.ceil(items.length / itemsPerPage);

      // Hide all items first
      for (const item of items) {
        item.style.display = 'none';
      }

      // Show items for current page
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      for (let i = startIndex; i < endIndex && i < items.length; i++) {
        items[i].style.display = 'block';
      }

      // Update pagination buttons
      updatePaginationButtons(totalPages);
    }

    // 生成智能分页页码数组的JavaScript版本
    function generatePageNumbers(current, total) {
      const delta = 2; // 当前页左右显示的页码数量
      const rangeWithDots = [];

      // 如果总页数小于等于7，显示所有页码
      if (total <= 7) {
        for (let i = 1; i <= total; i++) {
          rangeWithDots.push(i);
        }
        return rangeWithDots;
      }

      // 计算显示范围
      const left = Math.max(2, current - delta);
      const right = Math.min(total - 1, current + delta);

      // 始终显示第一页
      rangeWithDots.push(1);

      // 如果左边界大于2，添加省略号
      if (left > 2) {
        rangeWithDots.push('...');
      }

      // 添加中间页码
      for (let i = left; i <= right; i++) {
        rangeWithDots.push(i);
      }

      // 如果右边界小于最后一页-1，添加省略号
      if (right < total - 1) {
        rangeWithDots.push('...');
      }

      // 始终显示最后一页（如果总页数大于1）
      if (total > 1) {
        rangeWithDots.push(total);
      }

      return rangeWithDots;
    }

    function updatePaginationButtons(totalPages) {
      const prevButton = pagination.querySelector('[data-page="prev"]');
      const nextButton = pagination.querySelector('[data-page="next"]');
      const pageNumbersContainer = pagination.querySelector(`[data-page-numbers="${sectionId}"]`);

      if (prevButton) {
        prevButton.disabled = currentPage === 1;
      }

      if (nextButton) {
        nextButton.disabled = currentPage === totalPages;
      }

      if (pageNumbersContainer) {
        pageNumbersContainer.innerHTML = '';
        const pageNumbers = generatePageNumbers(currentPage, totalPages);

        pageNumbers.forEach(pageItem => {
          if (pageItem === '...') {
            const span = document.createElement('span');
            span.className = 'mx-1 text-neutral-500 font-bold flex items-center justify-center h-11'; 
            span.textContent = '...';
            pageNumbersContainer.appendChild(span);
          } else {
            if (pageItem === currentPage) {
                const div = document.createElement('div');
                div.className = 'h-11 w-11 rounded-lg bg-[var(--primary)] flex items-center justify-center font-bold text-white dark:text-black/70';
                div.textContent = pageItem;
                pageNumbersContainer.appendChild(div);
            } else {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn-card w-11 h-11 rounded-lg overflow-hidden active:scale-[0.85]';
                button.dataset.page = pageItem.toString();
                button.dataset.section = sectionId;
                button.textContent = pageItem.toString();
                button.addEventListener('click', function() {
                  currentPage = pageItem;
                  updatePage();
                });
                pageNumbersContainer.appendChild(button);
            }
          }
        });
      }
    }

    const pageNumbersContainer = pagination.querySelector(`[data-page-numbers="${sectionId}"]`);
    const initialPageButtons = pageNumbersContainer ? pageNumbersContainer.querySelectorAll('button[data-page]') : [];
    initialPageButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            currentPage = parseInt(this.dataset.page);
            updatePage();
        });
    });

    updatePage();
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPagination);
  } else {
    initPagination();
  }
</script>