---
const { post } = Astro.props;
---

<div class="card-base rounded-[var(--radius-large)] p-6 mb-4">
  <script
    src="https://giscus.app/client.js"
    data-repo="fengyegf/Comments"
    data-repo-id="R_kgDOM_UG0Q"
    data-category="Announcements"
    data-category-id="DIC_kwDOM_UG0c4CjTaf"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="preferred_color_scheme"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async></script>
</div>

<script is:inline>
  (function () {
    // 确保更新函数只定义一次
    if (!window.updateGiscusTheme) {
      window.updateGiscusTheme = function () {
        const theme = document.documentElement.classList.contains("dark")
          ? "dark"
          : "light";
        const iframe = document.querySelector("iframe.giscus-frame");
        if (!iframe) return;
        iframe.contentWindow.postMessage(
          { giscus: { setConfig: { theme } } },
          "https://giscus.app",
        );
      };
    }

    // 确保 Observer 只定义一次
    if (!window.giscusThemeObserver) {
      window.giscusThemeObserver = new MutationObserver(
        window.updateGiscusTheme,
      );
      window.giscusThemeObserver.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ["class"],
      });
    }

    // 确保 Message 监听只定义一次
    if (!window.handleGiscusMessage) {
      window.handleGiscusMessage = function (event) {
        if (event.origin === "https://giscus.app") {
          window.updateGiscusTheme();
        }
      };
      window.addEventListener("message", window.handleGiscusMessage);
    }

    // 每次组件加载时尝试更新主题
    // 延迟执行以确保 iframe 可能已创建
    setTimeout(() => {
      window.updateGiscusTheme();
    }, 1000);
  })();
</script>
